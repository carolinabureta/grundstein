<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=My><meta name=author content=Lyz><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.11"><title>AWS WAF - The Red Lobster Book</title><link rel=stylesheet href=../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/timeago.css><link rel=stylesheet href=../stylesheets/extra.css><link rel=stylesheet href=../stylesheets/links.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#extracting-information class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> </div> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="The Red Lobster Book" class="md-header__button md-logo" aria-label="The Red Lobster Book" data-md-component=logo> <img src=../img/logo.bmp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> The Red Lobster Book </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> AWS WAF </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/realcaptainsolaris/redbook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> realcaptainsolaris/redbook </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="The Red Lobster Book" class="md-nav__button md-logo" aria-label="The Red Lobster Book" data-md-component=logo> <img src=../img/logo.bmp alt=logo> </a> The Red Lobster Book </label> <div class=md-nav__source> <a href=https://github.com/realcaptainsolaris/redbook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> realcaptainsolaris/redbook </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../contact/ class=md-nav__link> <span class=md-ellipsis> Contact </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Uebungen </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Uebungen </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../uebungen/beispiel/ class=md-nav__link> <span class=md-ellipsis> Test1 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#extracting-information class=md-nav__link> <span class=md-ellipsis> Extracting information </span> </a> <nav class=md-nav aria-label="Extracting information"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-log-insights-queries class=md-nav__link> <span class=md-ellipsis> Creating Log Insights queries </span> </a> <nav class=md-nav aria-label="Creating Log Insights queries"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#useful-queries class=md-nav__link> <span class=md-ellipsis> Useful Queries </span> </a> <nav class=md-nav aria-label="Useful Queries"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#top-ips class=md-nav__link> <span class=md-ellipsis> Top IPs </span> </a> <nav class=md-nav aria-label="Top IPs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#top-ips-query class=md-nav__link> <span class=md-ellipsis> Top IPs query </span> </a> </li> <li class=md-nav__item> <a href=#top-ips-by-uri class=md-nav__link> <span class=md-ellipsis> Top IPs by uri </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#top-uris class=md-nav__link> <span class=md-ellipsis> Top URIs </span> </a> <nav class=md-nav aria-label="Top URIs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#top-uris-query class=md-nav__link> <span class=md-ellipsis> Top URIs query </span> </a> </li> <li class=md-nav__item> <a href=#top-uris-of-a-termination-rule class=md-nav__link> <span class=md-ellipsis> Top URIs of a termination rule </span> </a> </li> <li class=md-nav__item> <a href=#top-uris-of-an-ip class=md-nav__link> <span class=md-ellipsis> Top URIs of an IP </span> </a> </li> <li class=md-nav__item> <a href=#top-uris-of-a-cloudfront-id class=md-nav__link> <span class=md-ellipsis> Top URIs of a Cloudfront ID </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#waf-top-terminating-rules class=md-nav__link> <span class=md-ellipsis> WAF Top terminating rules </span> </a> </li> <li class=md-nav__item> <a href=#top-blocks-by-cloudfront-id class=md-nav__link> <span class=md-ellipsis> Top blocks by Cloudfront ID </span> </a> </li> <li class=md-nav__item> <a href=#top-allows-by-cloudfront-id class=md-nav__link> <span class=md-ellipsis> Top allows by Cloudfront ID </span> </a> </li> <li class=md-nav__item> <a href=#waf-top-countries class=md-nav__link> <span class=md-ellipsis> WAF Top countries </span> </a> </li> <li class=md-nav__item> <a href=#requests-by class=md-nav__link> <span class=md-ellipsis> Requests by </span> </a> <nav class=md-nav aria-label="Requests by"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#requests-by-ip class=md-nav__link> <span class=md-ellipsis> Requests by IP </span> </a> </li> <li class=md-nav__item> <a href=#requests-by-termination-rule class=md-nav__link> <span class=md-ellipsis> Requests by termination rule </span> </a> </li> <li class=md-nav__item> <a href=#requests-by-uri class=md-nav__link> <span class=md-ellipsis> Requests by URI </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#waf-top-args-of-an-uri class=md-nav__link> <span class=md-ellipsis> WAF Top Args of an URI </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#analysis-workflow class=md-nav__link> <span class=md-ellipsis> Analysis workflow </span> </a> <nav class=md-nav aria-label="Analysis workflow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#analyze-the-traffic-of-the-top-ips class=md-nav__link> <span class=md-ellipsis> Analyze the traffic of the top IPS </span> </a> </li> <li class=md-nav__item> <a href=#analyze-the-top-uris class=md-nav__link> <span class=md-ellipsis> Analyze the top uris </span> </a> </li> <li class=md-nav__item> <a href=#analyze-the-terminating-rules class=md-nav__link> <span class=md-ellipsis> Analyze the terminating rules </span> </a> </li> <li class=md-nav__item> <a href=#mark-ip-as-problematic class=md-nav__link> <span class=md-ellipsis> Mark IP as problematic </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>AWS WAF</h1> <p><a href=https://aws.amazon.com/waf/ >AWS WAF</a> is a web application firewall that helps protect your web applications or APIs against common web exploits and bots that may affect availability, compromise security, or consume excessive resources. AWS WAF gives you control over how traffic reaches your applications by enabling you to create security rules that control bot traffic and block common attack patterns, such as SQL injection or cross-site scripting. You can also customize rules that filter out specific traffic patterns.</p> <h2 id=extracting-information>Extracting information<a class=headerlink href=#extracting-information title="Permanent link">⚑</a></h2> <p>You can configure the WAF to write it's logs into S3, Kinesis or a Cloudwatch log group. S3 saves the data in small compressed files which are difficult to analyze, Kinesis makes sense if you post-process the data on a log system such as <a href=../graylog/ >graylog</a>, the last one allows you to use the WAF's builtin cloudwatch log insights which has the next interesting reports: . * Top 100 Ip addresses * Top 100 countries * Top 100 hosts * Top 100 terminating rules . Nevertheless, it still lacks some needed reports to analyze the traffic. But it's quite easy to build them yourself in Cloudwatch Log Insights. If you have time I'd always suggest to avoid using proprietary AWS tools, but sadly it's the quickest way to get results.</p> <h3 id=creating-log-insights-queries>Creating Log Insights queries<a class=headerlink href=#creating-log-insights-queries title="Permanent link">⚑</a></h3> <p>Inside the Cloudwatch site, on the left menu you'll see the <code>Logs</code> tab, and under it <code>Log Insights</code>. There you can write the query you want to run. Once it returns the expected result, you can save it. Saved queries can be seen on the right menu, under <code>Queries</code>.</p> <p>If you later change the query, you'll see a blue dot beside the query you last run. The query will remain changed until you click on <code>Actions</code> and then <code>Reset</code>.</p> <h4 id=useful-queries>Useful Queries<a class=headerlink href=#useful-queries title="Permanent link">⚑</a></h4> <h5 id=top-ips>Top IPs<a class=headerlink href=#top-ips title="Permanent link">⚑</a></h5> <p>Is a directory to save the queries to analyze a count of requests aggregated by ips.</p> <h6 id=top-ips-query>Top IPs query<a class=headerlink href=#top-ips-query title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields httpRequest.clientIp
| stats count(*) as requestCount by httpRequest.clientIp
| sort requestCount desc
| limit 100
</code></pre></div> <h6 id=top-ips-by-uri>Top IPs by uri<a class=headerlink href=#top-ips-by-uri title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields httpRequest.clientIp
| filter httpRequest.uri like &quot;/&quot;
| stats count(*) as requestCount by httpRequest.clientIp
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=top-uris>Top URIs<a class=headerlink href=#top-uris title="Permanent link">⚑</a></h5> <p>Is a directory to save the queries to analyze a count of requests aggregated by uris.</p> <h6 id=top-uris-query>Top URIs query<a class=headerlink href=#top-uris-query title="Permanent link">⚑</a></h6> <p>This report shows all the uris that are allowed to pass the WAF.</p> <div class=highlight><pre><span></span><code>fields httpRequest.uri
| filter action like &quot;ALLOW&quot;
| stats count(*) as requestCount by httpRequest.uri
| sort requestCount desc
| limit 100
</code></pre></div> <h6 id=top-uris-of-a-termination-rule>Top URIs of a termination rule<a class=headerlink href=#top-uris-of-a-termination-rule title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields httpRequest.uri
| filter terminatingRuleId like &quot;AWS-AWSManagedRulesUnixRuleSet&quot;
| stats count(*) as requestCount by httpRequest.uri
| sort requestCount desc
| limit 100
</code></pre></div> <h6 id=top-uris-of-an-ip>Top URIs of an IP<a class=headerlink href=#top-uris-of-an-ip title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields httpRequest.uri
| filter @message like &quot;6.132.241.132&quot;
| stats count(*) as requestCount by httpRequest.uri
| sort requestCount desc
| limit 100
</code></pre></div> <h6 id=top-uris-of-a-cloudfront-id>Top URIs of a Cloudfront ID<a class=headerlink href=#top-uris-of-a-cloudfront-id title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields httpRequest.uri
| filter httpSourceId like &quot;CLOUDFRONT_ID&quot;
| stats count(*) as requestCount by httpRequest.uri
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=waf-top-terminating-rules>WAF Top terminating rules<a class=headerlink href=#waf-top-terminating-rules title="Permanent link">⚑</a></h5> <p>Report that shows the top rules that are blocking the content.</p> <div class=highlight><pre><span></span><code>fields terminatingRuleId
| filter terminatingRuleId not like &quot;Default_Action&quot;
| stats count(*) as requestCount by terminatingRuleId
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=top-blocks-by-cloudfront-id>Top blocks by Cloudfront ID<a class=headerlink href=#top-blocks-by-cloudfront-id title="Permanent link">⚑</a></h5> <div class=highlight><pre><span></span><code>fields httpSourceId
| filter terminatingRuleId not like &quot;Default_Action&quot;
| stats count(*) as requestCount by httpSourceId
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=top-allows-by-cloudfront-id>Top allows by Cloudfront ID<a class=headerlink href=#top-allows-by-cloudfront-id title="Permanent link">⚑</a></h5> <div class=highlight><pre><span></span><code>fields httpSourceId
| filter terminatingRuleId like &quot;Default_Action&quot;
| stats count(*) as requestCount by httpSourceId
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=waf-top-countries>WAF Top countries<a class=headerlink href=#waf-top-countries title="Permanent link">⚑</a></h5> <div class=highlight><pre><span></span><code>fields httpRequest.country
| stats count(*) as requestCount by httpRequest.country
| sort requestCount desc
| limit 100
</code></pre></div> <h5 id=requests-by>Requests by<a class=headerlink href=#requests-by title="Permanent link">⚑</a></h5> <p>Is a directory to save the queries to show the requests filtered by a criteria.</p> <h6 id=requests-by-ip>Requests by IP<a class=headerlink href=#requests-by-ip title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields @timestamp, httpRequest.uri, httpRequest.args, httpSourceId
| sort @timestamp desc
| filter @message like &quot;6.132.241.132&quot;
| limit 100
</code></pre></div> <h6 id=requests-by-termination-rule>Requests by termination rule<a class=headerlink href=#requests-by-termination-rule title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields @timestamp, httpRequest.uri, httpRequest.args, httpSourceId
| sort @timestamp desc
| filter terminatingRuleId like &quot;AWS-AWSManagedRulesUnixRuleSet&quot;
| limit 100
</code></pre></div> <h6 id=requests-by-uri>Requests by URI<a class=headerlink href=#requests-by-uri title="Permanent link">⚑</a></h6> <div class=highlight><pre><span></span><code>fields @timestamp, httpRequest.uri, httpRequest.args, httpSourceId
| sort @timestamp desc
| filter httpRequest.uri like &quot;wp-json&quot;
| limit 100
</code></pre></div> <h5 id=waf-top-args-of-an-uri>WAF Top Args of an URI<a class=headerlink href=#waf-top-args-of-an-uri title="Permanent link">⚑</a></h5> <div class=highlight><pre><span></span><code>fields httpRequest.args
| filter httpRequest.uri like &quot;/&quot;
| stats count(*) as requestCount by httpRequest.args
| sort requestCount desc
| limit 100
</code></pre></div> <h3 id=analysis-workflow>Analysis workflow<a class=headerlink href=#analysis-workflow title="Permanent link">⚑</a></h3> <p>To analyze the WAF insights you can:</p> <ul> <li><a href=#analyze-the-traffic-of-the-top-ips>Analyze the traffic of the top IPs</a></li> <li><a href=#analyze-the-top-uris>Analyze the top URIs</a></li> <li><a href=#analyze-the-terminating-rules>Analyze the terminating rules</a></li> </ul> <h4 id=analyze-the-traffic-of-the-top-ips>Analyze the traffic of the top IPS<a class=headerlink href=#analyze-the-traffic-of-the-top-ips title="Permanent link">⚑</a></h4> <p>For IP in the <a href=#top-ips-query>WAF Top IPs</a> report, do:</p> <ul> <li> <p>Analyze the <a href=#top-uris-of-an-ip>top uris of that IP</a> to see if they are legit requests or if it contains malicious requests. If you want to get the details of a particular request, you can use the <a href=#requests-by-uri>requests by uri</a> report.</p> <p>For request in malicious requests:</p> <ul> <li>If it's not being filtered by the WAF update your WAF rules.</li> </ul> </li> <li> <p>If the IP is malicious <a href=#mark-ip-as-problematic>mark it as problematic</a>.</p> </li> </ul> <h4 id=analyze-the-top-uris>Analyze the top uris<a class=headerlink href=#analyze-the-top-uris title="Permanent link">⚑</a></h4> <p>For uri in the <a href=#top-uris>WAF Top URIs</a> report, do:</p> <ul> <li> <p>For argument in the <a href=#waf-top-args-of-an-uri>top arguments of that uri</a> report, see if they are legit requests or if it's malicious. If you want to get the details of a particular request, you can use the <a href=#waf-requests-by-uri>requests by uri</a> report.</p> <p>For request in malicious requests:</p> <ul> <li>If it's not being filtered by the WAF update your WAF rules.</li> <li>For IP in <a href=#top-uris-by-ip>top uris by IP</a> report:<ul> <li><a href=#mark-ip-as-problematic>Mark IP as problematic</a>.</li> </ul> </li> </ul> </li> </ul> <h4 id=analyze-the-terminating-rules>Analyze the terminating rules<a class=headerlink href=#analyze-the-terminating-rules title="Permanent link">⚑</a></h4> <p>For terminating rule in the <a href=#waf-top-terminating-rules>WAF Top terminating rules</a> report, do:</p> <ul> <li>For IP in the <a href=#top-ips-by-termination-rule>top ips by termination rule</a> <a href=#mark-ip-as-problematic>mark it as problematic</a>.</li> </ul> <p>After some time you can see which rules are not being triggered and remove them. With the <a href=#requests-by-termination-rule>requests by termination rule</a> you can see which requests are being blocked and try to block it in another rule set and merge both.</p> <h4 id=mark-ip-as-problematic>Mark IP as problematic<a class=headerlink href=#mark-ip-as-problematic title="Permanent link">⚑</a></h4> <p>To process an problematic IP:</p> <ul> <li>Add it to the captcha list.</li> <li>If it is already in the captcha list and is still triggering problematic requests, add it to the block list.</li> <li>Add a task to remove the IP from the block or captcha list X minutes or hours in the future.</li> </ul> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">⚑</a></h2> <ul> <li><a href=https://aws.amazon.com/waf/ >Homepage</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2024-08-30T08:35:48+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-30</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/benkyonodo target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.instant", "navigation.top", "content.code.annotate", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.8fd75fb4.min.js></script> <script src=../js/timeago.min.js></script> <script src=../js/timeago_mkdocs_material.js></script> </body> </html>